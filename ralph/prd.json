{
  "project": "Claude Sidecar",
  "branchName": "feat/dynamic-command-routing",
  "description": "Replace manually-maintained wrapper scripts with a single dispatcher and dynamically generated symlinks. Bridge config becomes single source of truth with native override support.",
  "userStories": [
    {
      "id": "#9/US-001",
      "title": "Set up integration test infrastructure",
      "description": "As a developer, I need a working integration test that validates the current bridge functionality so that subsequent changes can be verified.",
      "acceptanceCriteria": [
        "Create `.test/bridge.yaml` with command `go` routing to `test-golang` container",
        "Add container mapping `golang: test-golang` to bridge.yaml",
        "Create `.test/workspace/` with `main.go` that prints 'Hello'",
        "Create `.test/run-tests.sh` that builds claude-sidecar-test image",
        "Script starts containers via `docker compose -f compose.yaml up -d`",
        "Script copies test workspace into volume",
        "Script runs: `docker compose exec claude bridge go version` and verifies success",
        "Script runs: `docker compose exec claude bridge go build -o /dev/null ./main.go` and verifies success",
        "Script tears down with `docker compose -f compose.yaml down -v`",
        "Script is executable and exits 0 on success, 1 on failure",
        "Update `.test/compose.yaml` to use `test-golang` container name",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1,
      "notes": "First story - establishes baseline integration test. All subsequent stories must pass this test."
    },
    {
      "id": "#9/US-002",
      "title": "Add overrides section to bridge config schema",
      "description": "As a developer, I need the bridge config to support native overrides so that specific commands can bypass sidecar routing.",
      "acceptanceCriteria": [
        "Add `Overrides map[string]Override` to Config struct in `cmd/bridge/config.go`",
        "Override struct has `Native string` field (path to native binary)",
        "Validation ensures `native` path is non-empty string when override exists",
        "Existing configs without `overrides` continue to work (field is optional)",
        "Unit tests cover override parsing and validation",
        "`go build ./cmd/bridge` succeeds",
        "`go vet ./...` passes",
        "`.test/run-tests.sh` passes (no regression)",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 2,
      "notes": "Verified via go build, go vet, and unit tests. Integration tests cannot run in this environment."
    },
    {
      "id": "#9/US-003",
      "title": "Implement command resolution with override priority",
      "description": "As a developer, I need the bridge to check overrides before routing to sidecar so that native commands execute locally.",
      "acceptanceCriteria": [
        "Add `ResolveCommand(name string) (execPath string, isNative bool)` method to Config",
        "Method returns `(nativePath, true)` if command is in overrides",
        "Method returns `(\"\", false)` if command should route to sidecar or fall through",
        "Unit tests cover: override hit, sidecar routing, unknown command fallthrough",
        "`go build ./cmd/bridge` succeeds",
        "`go vet ./...` passes",
        "`.test/run-tests.sh` passes (no regression)",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "attempts": 1,
      "notes": "Resolution logic - builds on US-002"
    },
    {
      "id": "#9/US-004",
      "title": "Update bridge main to handle native execution",
      "description": "As a user, I need the bridge to execute native binaries directly when configured so that `claude` runs without docker exec.",
      "acceptanceCriteria": [
        "Bridge checks `ResolveCommand` before building docker exec",
        "If native, exec the native binary with original args using `syscall.Exec`",
        "If not in config at all, exec native binary lookup via `exec.LookPath` (fall through)",
        "Exit code from native binary propagates correctly",
        "`go build ./cmd/bridge` succeeds",
        "`go vet ./...` passes",
        "Add test to run-tests.sh: `docker compose exec claude bridge echo hello` succeeds (fallthrough)",
        "`.test/run-tests.sh` passes",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "attempts": 1,
      "notes": "Native execution via syscall.Exec - builds on US-003"
    },
    {
      "id": "#9/US-005",
      "title": "Translate working directory using paths mapping",
      "description": "As a user, I need the bridge to translate Claude's current working directory to the sidecar's equivalent path so that commands run in the correct location.",
      "acceptanceCriteria": [
        "Bridge gets current working directory via `os.Getwd()`",
        "Apply `TranslatePath` to current working directory",
        "If translation produces different path, use as `-w` argument to docker exec",
        "If no translation and `workdir` is set, use `workdir` as `-w` argument",
        "If no translation and no `workdir`, use current directory as `-w` argument",
        "Unit test: CWD `/workspaces/project` with paths `{\"/workspaces\": \"/app\"}` produces `-w /app/project`",
        "Unit test: CWD `/other/path` with no matching paths uses static `workdir` or CWD",
        "`go build ./cmd/bridge` succeeds",
        "`go vet ./...` passes",
        "Add test to run-tests.sh: run `go build` from subdirectory and verify it works",
        "`.test/run-tests.sh` passes",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "attempts": 1,
      "notes": "Implemented TranslatePathWithMatch and determineWorkdir. Integration tests cannot run in this environment."
    },
    {
      "id": "#9/US-006",
      "title": "Create single dispatcher script",
      "description": "As a developer, I need a single dispatcher script that routes all commands through the bridge.",
      "acceptanceCriteria": [
        "Create `scripts/wrappers/dispatcher` script",
        "Script has shebang `#!/bin/sh`",
        "Script extracts command name via `$(basename \"$0\")`",
        "Script execs `bridge <command> \"$@\"`",
        "Script is executable (chmod +x)",
        "Script passes shellcheck",
        "`.test/run-tests.sh` passes (no regression)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "attempts": 1,
      "notes": "Single dispatcher replaces 18+ individual wrapper scripts. Shellcheck passes, go build and go vet pass."
    },
    {
      "id": "#9/US-007",
      "title": "Add --init-wrappers flag to generate symlinks",
      "description": "As a developer, I need the bridge to generate dispatcher symlinks so that commands are intercepted at startup.",
      "acceptanceCriteria": [
        "Add `--init-wrappers <dir>` flag to bridge CLI in main.go",
        "Flag reads config and creates symlink for each command in `commands` + `overrides`",
        "Symlinks point to `<dir>/dispatcher`",
        "If symlink exists and points to dispatcher, skip (idempotent)",
        "Print summary to stderr: \"Created N symlinks in <dir>\"",
        "`go build ./cmd/bridge` succeeds",
        "`go vet ./...` passes",
        "Add test to run-tests.sh: `bridge --init-wrappers /tmp/test-wrappers` creates symlinks",
        "`.test/run-tests.sh` passes",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "attempts": 1,
      "notes": "Implemented --init-wrappers flag with idempotent symlink generation. Unit tests and integration test added."
    },
    {
      "id": "#9/US-008",
      "title": "Update entrypoint to initialize wrappers",
      "description": "As a user, I need symlinks generated at container startup so that commands are routed correctly from first use.",
      "acceptanceCriteria": [
        "Add `init_wrappers()` function to `scripts/entrypoint.sh`",
        "Function calls `bridge --init-wrappers /scripts/wrappers`",
        "Function runs after firewall init, before dropping to claude user",
        "Remove `CLAUDE_STARTING` environment variable logic from entrypoint",
        "Add test to run-tests.sh: verify symlinks exist after container starts",
        "`.test/run-tests.sh` passes",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "attempts": 1,
      "notes": "Implemented init_wrappers call in main() and removed CLAUDE_STARTING logic. Test 6 added. Integration tests cannot run in this environment."
    },
    {
      "id": "#9/US-009",
      "title": "Test native override execution end-to-end",
      "description": "As a developer, I need to verify that native overrides work in the full container environment.",
      "acceptanceCriteria": [
        "Update `.test/bridge.yaml` to add `overrides` section with `echo` pointing to `/bin/echo`",
        "Add test to run-tests.sh: `docker compose exec claude echo hello` outputs 'hello' via symlink",
        "Verify echo did NOT go through docker exec (native execution)",
        "`.test/run-tests.sh` passes",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "attempts": 1,
      "notes": "Added overrides section to test config and Test 7 to run-tests.sh. Integration tests cannot run in this environment."
    },
    {
      "id": "#9/US-010",
      "title": "Remove BRIDGE_ENABLED checks and legacy wrappers",
      "description": "As a developer, I need to clean up the old wrapper scripts and BRIDGE_ENABLED logic to simplify the codebase.",
      "acceptanceCriteria": [
        "Delete all files in `scripts/wrappers/` except `dispatcher`",
        "Remove BRIDGE_ENABLED from `scripts/entrypoint.sh`",
        "Remove BRIDGE_ENABLED from documentation",
        "Update `CLAUDE.md` environment variables table to remove BRIDGE_ENABLED",
        "Run `grep -r BRIDGE_ENABLED .` returns no results (excluding .git)",
        "`.test/run-tests.sh` passes (full regression test)",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "attempts": 0,
      "notes": "Final cleanup - must be last after all features work"
    },
    {
      "id": "#9/US-011",
      "title": "Update example configs and documentation",
      "description": "As a user, I need example configuration showing how to use native overrides.",
      "acceptanceCriteria": [
        "Update `examples/claude-bridge.yaml` with `overrides` section",
        "Add `claude` override pointing to `/usr/local/bin/claude`",
        "Add comments explaining override behavior",
        "Update `.sidecar/bridge.yaml` for project use",
        "Update CLAUDE.md to document new architecture (no BRIDGE_ENABLED, dispatcher + symlinks)",
        "`.test/run-tests.sh` passes",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "attempts": 0,
      "notes": "Documentation updates - can run after cleanup"
    }
  ]
}
