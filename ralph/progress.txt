## Codebase Patterns
- Use hadolint via Docker for Dockerfile linting: `docker run --rm -i hadolint/hadolint < Dockerfile`
- Node.js 20 Alpine base image: `node:20-alpine`
- node:20-alpine has existing node user/group at UID/GID 1000 - use 1001 for custom users
- Create non-root user with: `addgroup -g 1001 name && adduser -u 1001 -G name -h /home/name -D name`
- Claude Code npm package: `@anthropic-ai/claude-code` (pin version for hadolint compliance)
- Docker CLI on Alpine: `docker-cli` package (client only, no daemon) - pin version for hadolint
- Validate YAML syntax with: `docker run --rm -v /path:/data mikefarah/yq '.' /data/file.yaml`
- Shellcheck via Docker: `docker run --rm -v /path:/scripts koalaman/shellcheck:stable /scripts/scriptname`
- Use `# shellcheck shell=dash` directive for Alpine shell scripts (dash supports `local` keyword)
- yq binary can be downloaded via multi-stage build from GitHub releases

---

## 2026-01-18 - US-001
- What was implemented: Base Dockerfile with Alpine Linux, Node.js 20+ LTS, multi-stage build structure, non-root 'claude' user, and /workspace working directory
- Files changed: Dockerfile (created)
- **Learnings for future iterations:**
  - Node.js 20 Alpine image is `node:20-alpine`
  - Multi-stage builds use `AS` alias for stages
  - Alpine uses `addgroup`/`adduser` instead of `groupadd`/`useradd`
  - hadolint returns empty output when Dockerfile passes
---

## 2026-01-18 - US-002
- What was implemented: Added claude-code CLI installation to Docker image via npm global install
- Files changed: Dockerfile (modified)
- **Learnings for future iterations:**
  - The npm package for Claude Code is `@anthropic-ai/claude-code`
  - hadolint requires pinned npm versions (DL3016) - use `package@version` format
  - Clean npm cache with `npm cache clean --force` to reduce image size
  - Check latest npm package version with: `npm view <package> version`
---

## 2026-01-18 - US-003
- What was implemented: Added Docker CLI client to image with DOCKER_HOST environment variable for container communication
- Files changed: Dockerfile (modified)
- **Learnings for future iterations:**
  - Alpine provides `docker-cli` package which contains only the Docker client (no daemon)
  - hadolint DL3018 requires pinning apk package versions: `apk add --no-cache package=version`
  - Check available Alpine package version with: `docker run --rm node:20-alpine apk info <package>`
  - DOCKER_HOST can be set to empty string as default, allowing override at runtime or via docker-compose
---

## 2026-01-18 - US-004
- What was implemented: Created bridge config YAML schema with documented example at examples/claude-bridge.yaml
- Files changed: examples/claude-bridge.yaml (created)
- **Learnings for future iterations:**
  - Bridge config schema supports: version, default_container, containers (name overrides), commands (with container, exec, workdir)
  - Use yq via Docker for YAML validation: `docker run --rm -v /path:/data mikefarah/yq '.' /data/file.yaml`
  - Example files should be well-commented to serve as both documentation and working templates
  - YAML keys with special characters like colons need quoting: `"test:php"`
---

## 2026-01-18 - US-005
- What was implemented: Created bridge shell script with YAML config parsing using yq, including error handling for missing or invalid config files
- Files changed: scripts/bridge (created)
- **Learnings for future iterations:**
  - Use `# shellcheck shell=dash` directive to tell shellcheck that the script targets dash/ash (which supports `local`)
  - Alpine's sh is actually BusyBox ash which supports `local` keyword unlike strict POSIX sh
  - Shellcheck via Docker: `docker run --rm -v /path:/scripts koalaman/shellcheck:stable /scripts/scriptname`
  - Bridge script uses BRIDGE_CONFIG env var to allow config path override (defaults to /workspace/.claude/bridge.yaml)
  - yq queries: `.version // ""` provides default value if key missing, `.key | type` checks if key exists
---

## 2026-01-18 - US-006
- What was implemented: Added command routing functionality to the bridge script including command lookup, container name resolution, docker exec command building, and argument passthrough
- Files changed: scripts/bridge (modified)
- **Learnings for future iterations:**
  - yq bracket notation for quoted keys: `.commands["test:php"]` to access keys with special characters
  - Global variables (CMD_CONTAINER, CMD_EXEC, CMD_WORKDIR) work well for passing data between functions in shell scripts
  - Use `shift` to separate first argument from remaining ones for cleaner argument handling
  - `# shellcheck disable=SC2086` allows word splitting when intentional (for building command strings)
  - Default container fallback requires checking both empty string and "null" (yq returns "null" for missing keys)
---

## 2026-01-18 - US-007
- What was implemented: Added real-time output streaming with TTY allocation (-t flag) and exit code propagation to the bridge script
- Files changed: scripts/bridge (modified)
- **Learnings for future iterations:**
  - Use `[ -t 1 ]` to check if STDOUT is connected to a terminal before allocating TTY
  - TTY allocation (`docker exec -t`) enables real-time unbuffered output streaming
  - Exit codes automatically propagate when the docker exec command is the last command in the function/script
  - STDOUT and STDERR stream directly through docker exec without needing special handling
  - Document output behavior in the usage/help section for user awareness
---

## 2026-01-18 - US-008
- What was implemented: Verified and fixed bridge script installation in Docker image. Fixed UID/GID conflict with pre-existing node user in node:20-alpine base image.
- Files changed: Dockerfile (modified - changed claude user UID/GID from 1000 to 1001)
- **Learnings for future iterations:**
  - node:20-alpine already has a 'node' user/group with UID/GID 1000
  - Must use different IDs (e.g., 1001) when creating custom users in node-based images
  - yq binary is downloaded in builder stage and copied to runtime stage for YAML parsing
  - Test image builds early to catch runtime errors (e.g., user/group conflicts)
  - Verify all CLI tools work with --help/--version before marking story complete
---

## 2026-01-18 - US-009
- What was implemented: Added compose.yml (v2 format) to complete docker-compose examples. The docker-compose.yml (v1) was already present.
- Files changed: examples/compose.yml (created)
- **Learnings for future iterations:**
  - Docker Compose V2 uses compose.yml by default (no version field required)
  - Both formats (v1 with version field, v2 without) are valid and work with `docker compose` command
  - Validate YAML syntax with: `docker run --rm -v /path:/data mikefarah/yq '.' /data/file.yaml`
  - tecnativa/docker-socket-proxy is the standard secure Docker socket proxy image
  - Key proxy settings: CONTAINERS=1, EXEC=1, POST=1 for Claude bridge script to work
---

## 2026-01-18 - US-010
- What was implemented: Added session persistence volume mount to docker-compose examples with graceful fallback support
- Files changed:
  - examples/docker-compose.yml (modified - added .claude volume mount)
  - examples/compose.yml (modified - added .claude volume mount)
  - Dockerfile (modified - pre-create /home/claude/.claude directory)
- **Learnings for future iterations:**
  - Volume mounts for session persistence should be optional with graceful fallback
  - Pre-creating directories in Dockerfile ensures container works with or without volume mount
  - Document what gets persisted in volume (auth tokens, settings, session state) in compose comments
  - The hadolint command via input redirection may be blocked; use volume mount instead
---

## 2026-01-19 - US-011
- What was implemented: Added YOLO mode environment variable support to docker-compose examples with comprehensive security documentation
- Files changed:
  - examples/docker-compose.yml (modified - added CLAUDE_YOLO env var with security warnings)
  - examples/compose.yml (modified - added CLAUDE_YOLO env var with security warnings)
- **Learnings for future iterations:**
  - YOLO mode (CLAUDE_YOLO=1) disables confirmation prompts in Claude Code
  - Security-sensitive features should be commented out by default (safe mode)
  - Include explicit warnings about destructive commands (rm -rf, DROP TABLE, etc.)
  - Documentation should emphasize "isolated development environments only"
---

## 2026-01-19 - US-012
- What was implemented: Created CLAUDE.md.template for multi-container projects with comprehensive sections
- Files changed:
  - examples/CLAUDE.md.template (created - 207 lines)
- **Template includes:**
  - Project overview section with tech stack placeholders
  - Container topology table with example containers
  - Bridge command reference with PHP, Node.js, and database examples
  - Testing commands section and testing strategy
  - "Do Not" warnings section with multi-container gotchas
  - Codebase patterns section for project-specific learnings
- **Learnings for future iterations:**
  - CLAUDE.md templates should include concrete command examples (not just descriptions)
  - The "Do Not" section is critical for multi-container setups - prevents common mistakes
  - Include both correct and incorrect examples to make the guidance clear
  - Template placeholders like `[YOUR PROJECT NAME]` help users know what to customize
---

## 2026-01-19 - US-013
- What was implemented: Created README.md with comprehensive integration instructions
- Files changed:
  - README.md (created - 230 lines)
- **README includes:**
  - Quick start section with minimal docker-compose snippet (10 lines)
  - Bridge configuration reference with YAML schema documentation
  - Configuration reference tables for bridge.yaml fields
  - Session persistence section
  - Security best practices section with credential isolation warnings
  - YOLO mode documentation with security warnings
  - Examples directory reference
  - Build instructions
- **Learnings for future iterations:**
  - Quick start should be minimal (5-10 lines) to lower barrier to adoption
  - Security documentation should explicitly show what NOT to do (with code examples)
  - Reference tables are helpful for configuration schemas
  - Link to example files rather than duplicating content
---

## 2026-01-19 - US-014
- What was implemented: Verified credential isolation in Dockerfile and documentation. Added explicit warnings about sensitive directory mounts to CLAUDE.md.template
- Files changed:
  - examples/CLAUDE.md.template (modified - added "Do NOT mount sensitive host directories" section)
- **Verification completed:**
  - Dockerfile does not mount ~/.ssh, ~/.aws, ~/.config, or home directory (PASS - Dockerfile has no volume mounts)
  - README.md already warns against mounting sensitive directories (lines 158-177)
  - README.md documents passing credentials as env vars (lines 173-177)
  - Docker-compose examples only mount project directory and .claude session data
- **Learnings for future iterations:**
  - Security verification stories may require enhancing documentation rather than code changes
  - Warning messages are more effective with concrete "WRONG vs CORRECT" examples
  - The CLAUDE.md.template "Do Not" section is the right place for multi-container security warnings
---
