# Ralph Progress Log
Started: Wed Jan 21 14:07:23 CET 2026

## Codebase Patterns
- This is a Go project with Docker containerization for Claude Code
- Quality checks: `go vet ./...` and `go build ./...`
- Shell scripts in `/scripts/` use POSIX sh (dash compatible), not bash
- The entrypoint uses `exec` to replace the shell process with the target command
- Container starts as root for firewall setup, use `run_as_user` to drop privileges to claude user

---

## 2026-01-21 13:10 UTC - US-009
- **What was implemented**: Persistent container entrypoint that keeps container alive with `tail -f /dev/null`
- **Files changed**: `scripts/entrypoint.sh`
- **Implementation details**:
  - Changed default behavior: container now stays alive when no command provided
  - Added `run_claude()` function for Claude CLI execution
  - Added logic to detect `claude` as first argument and run Claude
  - Any other command is executed directly via `exec "$@"`
  - Default (no args) runs `tail -f /dev/null` to keep container alive
- **Learnings for future iterations**:
  - The entrypoint uses `CLAUDE_STARTING=1` env var for the node wrapper
  - `CLAUDE_YOLO=1` enables `--dangerously-skip-permissions` mode
  - Container workflow: `docker compose up -d` then `docker compose exec claude claude`
---

## 2026-01-21 14:30 UTC - US-010
- **What was implemented**: Added firewall dependency packages to the Alpine container image
- **Files changed**: `Dockerfile`
- **Implementation details**:
  - Added `iptables` package for firewall rules
  - Added `ipset` package for efficient IP set matching
  - Added `iproute2` package for `ip` command
  - Added `bind-tools` package for `dig` DNS resolution command
  - Added `curl` for fetching GitHub IP ranges from API
  - Added `jq` for parsing JSON responses
  - Reorganized apk command with one package per line for readability
  - Added documentation comments explaining each package's purpose
- **Learnings for future iterations**:
  - Alpine packages needed for firewall: iptables, ipset, iproute2, bind-tools, curl, jq
  - Docker build may not work in sandboxed environments due to network restrictions
  - Quality checks (go vet/build) still work even when Docker is restricted
---

## 2026-01-21 15:13 UTC - US-011
- **What was implemented**: Configurable firewall initialization script for network isolation
- **Files changed**: `scripts/init-firewall.sh`
- **Implementation details**:
  - Created `scripts/init-firewall.sh` script using POSIX sh (dash compatible)
  - Script reads custom allowed domains from `/workspace/.claude/allowed-domains.txt` if exists
  - Falls back to defaults: GitHub (dynamic), registry.npmjs.org, api.anthropic.com, sentry.io, statsig.anthropic.com, statsig.com
  - Uses `ipset` with hash:net type for efficient IP/CIDR matching
  - Fetches GitHub IP ranges from api.github.com/meta using curl + jq
  - Resolves domain names to IPs via `dig` (A records only)
  - Allows localhost (127.0.0.0/8) and Docker internal DNS (127.0.0.11)
  - Allows DNS queries (UDP/TCP port 53) before ipset check
  - Uses REJECT (not DROP) for unauthorized traffic - fast feedback
  - Logs progress and errors to stderr with `[firewall]` prefix
  - Includes tool availability checks (iptables, ipset, curl, jq, dig)
  - Requires root and NET_ADMIN/NET_RAW capabilities
- **Learnings for future iterations**:
  - ipset hash:net supports both individual IPs and CIDR blocks
  - GitHub API at api.github.com/meta returns git, web, and api IP ranges
  - REJECT is better than DROP for dev containers - gives immediate ICMP response
  - iptables OUTPUT rules: allow loopback first, then ESTABLISHED/RELATED, then DNS, then ipset match, finally REJECT all
---

## 2026-01-21 16:00 UTC - US-012
- **What was implemented**: Firewall verification function to test the firewall works correctly
- **Files changed**: `scripts/init-firewall.sh`
- **Implementation details**:
  - Added `verify_firewall()` function that tests both allowed and blocked connections
  - Tests api.github.com connection (should succeed - allowed via GitHub IP ranges)
  - Tests example.com connection (should fail - not in allowed list)
  - Uses curl with 5s timeout for quick feedback
  - Logs results with checkmarks (✓) for pass, (✗) for fail
  - Function returns non-zero exit code if any verification fails
  - Main function calls `verify_firewall` after setup and exits with error if it fails
- **Learnings for future iterations**:
  - Using curl with `-sf --max-time 5` for verification: `-s` silent, `-f` fail fast, short timeout
  - REJECT firewall rule gives immediate curl failure (vs DROP which would timeout)
  - Verification after firewall setup helps catch misconfigurations early
---

## 2026-01-21 16:45 UTC - US-013
- **What was implemented**: Docker Compose configuration for automatic firewall initialization
- **Files changed**: `compose.yaml`, `Dockerfile`, `scripts/entrypoint.sh`
- **Implementation details**:
  - Added `cap_add: [NET_ADMIN, NET_RAW]` to claude service in compose.yaml
  - Copied `init-firewall.sh` script to container at `/scripts/init-firewall.sh`
  - Removed `USER claude` from Dockerfile - container now starts as root
  - Added `init_firewall()` function to entrypoint that:
    - Checks for marker file `/tmp/.firewall_initialized` to skip if already done
    - Verifies firewall script exists and is executable
    - Runs script as root, creates marker on success
    - Fails gracefully with warning if initialization fails
  - Added `run_as_user()` function that uses `su -s /bin/sh claude -c "$*"` to drop privileges
  - Modified all command execution paths to use `run_as_user` (except `tail -f /dev/null`)
- **Learnings for future iterations**:
  - Container must start as root for firewall setup, then drop privileges via `su`
  - Marker file in `/tmp/` persists for container lifetime but not across restarts
  - `docker compose exec` runs as container user (root), so `run_as_user` is important
  - When using `su -c`, quote the command properly to handle arguments with spaces
---
