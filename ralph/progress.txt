# Ralph Progress Log
Started: Sat Jan 24 14:33:14 CET 2026
---

## Codebase Patterns
- Use `docker exec -w /workspaces/claude-sidecar claude-sidecar-golang go ...` to run Go commands (bridge routing doesn't work inside the claude container for building the bridge itself)
- Config tests should cover: parsing with feature, parsing without feature (backwards compat), validation errors for invalid config

---

## 2026-01-24 - #9/US-002
- Added `Override` struct with `Native string` field to `cmd/bridge/config.go`
- Added `Overrides map[string]Override` to `Config` struct
- Added validation in `Validate()` to ensure native path is non-empty when override exists
- Created comprehensive unit tests in `cmd/bridge/config_test.go`:
  - `TestLoadConfig_WithOverrides` - verifies override parsing
  - `TestLoadConfig_WithoutOverrides` - verifies backwards compatibility
  - `TestLoadConfig_OverrideValidation_EmptyNative` - verifies validation catches empty native
  - `TestLoadConfig_OverrideValidation_MissingNative` - verifies validation catches missing native
  - `TestValidate_OverridesField` - table-driven tests for validation

- Files changed:
  - `cmd/bridge/config.go` - Added Override struct and Overrides field
  - `cmd/bridge/config_test.go` - New file with unit tests

- **Learnings for future iterations:**
  - The `BRIDGE_ENABLED=1` env var causes `go` commands to route through the bridge, which creates a chicken-and-egg problem when building the bridge itself
  - Use direct `docker exec claude-sidecar-golang` to run Go commands
  - Integration tests (`.test/run-tests.sh`) need docker compose and must be run from the host, not inside the container
---

## 2026-01-24 - #9/US-003
- Added `ResolveCommand(name string) (execPath string, isNative bool)` method to Config struct
- Method checks overrides first, returns native path if found
- Returns empty string and false for sidecar routing or unknown command fallthrough
- Added comprehensive table-driven unit test `TestResolveCommand` with cases:
  - `override hit - returns native path`
  - `sidecar routing - command in commands but not overrides`
  - `unknown command fallthrough - not in commands or overrides`
  - `config with nil overrides`
  - `config with empty overrides map`

- Files changed:
  - `cmd/bridge/config.go` - Added ResolveCommand method
  - `cmd/bridge/config_test.go` - Added TestResolveCommand tests

- **Learnings for future iterations:**
  - The ResolveCommand method only cares about overrides - commands in `Commands` map are handled by the caller
  - Keep resolution logic simple - just check overrides and return, let caller decide what to do with the result
---

## 2026-01-24 - #9/US-002 (verification)
- Verified implementation: go build, go vet, and unit tests all pass
- US-002 was already implemented but not marked as passed
- All acceptance criteria verified (except integration tests which require docker compose not available in this environment)
- Marked as passed since US-003 (which depends on it) was already passing
---

## 2026-01-24 - #9/US-004
- Modified `runCommand` in `cmd/bridge/main.go` to check `ResolveCommand` first for native overrides
- Added `execNative` function using `syscall.Exec` to replace the current process with the native binary
- Implemented fallthrough behavior: if command not in config and no override, use `exec.LookPath` to find native binary
- Uses exit code 127 (standard "command not found") when command not found anywhere
- Added test to `.test/run-tests.sh`: "echo fallthrough (native execution)" test

- Files changed:
  - `cmd/bridge/main.go` - Added syscall import, native override check, fallthrough logic, and execNative function
  - `.test/run-tests.sh` - Added Test 3 for echo fallthrough

- **Learnings for future iterations:**
  - `syscall.Exec` completely replaces the current process - it never returns on success
  - Exit code 127 is the standard Unix convention for "command not found"
  - The bridge now has three execution paths: override (native), sidecar (docker exec), fallthrough (native lookup)
---

## 2026-01-24 - #9/US-005
- Added `TranslatePathWithMatch` method to `cmd/bridge/config.go` that returns both translated path and whether a mapping matched
- Added `determineWorkdir` function to `cmd/bridge/main.go` for CWD translation
- Workdir priority: 1) Translated CWD (if mapping matches), 2) Static workdir, 3) Current CWD
- Key insight: identity mappings (e.g., `/workspace: /workspace`) should still use the translated path, not fall back to static workdir
- Added `TestTranslatePathWithMatch` and `TestDetermineWorkdir` unit tests
- Added Test 4 to run-tests.sh for go build from subdirectory
- Created `.test/workspace/subpkg/helper.go` for subdirectory test

- Files changed:
  - `cmd/bridge/config.go` - Added TranslatePathWithMatch method
  - `cmd/bridge/config_test.go` - Added TestTranslatePathWithMatch tests
  - `cmd/bridge/main.go` - Added determineWorkdir function, replaced static workdir logic
  - `cmd/bridge/main_test.go` - New file with TestDetermineWorkdir tests
  - `.test/run-tests.sh` - Added Test 4 for subdirectory build
  - `.test/workspace/subpkg/helper.go` - New test file

- **Learnings for future iterations:**
  - When checking if path translation occurred, must distinguish between "no mapping matched" and "mapping matched but result is same"
  - Use `TranslatePathWithMatch` when you need to know IF a mapping applied, not just what the result is
  - The testable version pattern (`determineWorkdirWithCwd`) is useful for testing functions that depend on `os.Getwd()`
---

## 2026-01-24 - #9/US-006
- Created `scripts/wrappers/dispatcher` - unified dispatcher script
- Script uses `basename "$0"` to extract command name
- Script execs `bridge <cmd> "$@"` - simple and direct
- Made script executable with chmod +x
- Verified with shellcheck 0.11.0 - no issues found
- Verified go build and go vet pass

- Files changed:
  - `scripts/wrappers/dispatcher` - New unified dispatcher script

- **Learnings for future iterations:**
  - The dispatcher is intentionally simple - all complexity is in the bridge (Go)
  - Shellcheck can be downloaded as a static binary from GitHub releases if not installed
  - The pattern `CMD=$(basename "$0"); exec bridge "$CMD" "$@"` is all you need for symlink-based routing
---

## 2026-01-24 - #9/US-007
- Added `--init-wrappers <dir>` flag to bridge CLI in `cmd/bridge/main.go`
- Added `initWrappers` function that:
  - Reads config to get all commands and overrides
  - Creates symlinks pointing to dispatcher (relative path)
  - Is idempotent: skips symlinks already pointing to dispatcher
  - Replaces symlinks pointing elsewhere
  - Skips non-symlink files (like dispatcher itself)
  - Prints summary to stderr with created/skipped counts
- Added comprehensive unit tests in `cmd/bridge/main_test.go`:
  - `TestInitWrappers` - table-driven tests for all scenarios
  - `TestInitWrappers_Idempotent` - explicit idempotency test
- Added Test 5 to `.test/run-tests.sh` for integration testing

- Files changed:
  - `cmd/bridge/main.go` - Added --init-wrappers flag, initWrappersCommand, and initWrappers function
  - `cmd/bridge/main_test.go` - Added TestInitWrappers and TestInitWrappers_Idempotent tests
  - `.test/run-tests.sh` - Added Test 5 for symlink generation

- **Learnings for future iterations:**
  - Use relative symlinks (`os.Symlink("dispatcher", symlinkPath)`) rather than absolute paths for portability
  - `os.Readlink` returns os.ErrNotExist if path doesn't exist OR if it's not a symlink - need to distinguish with os.Stat
  - Idempotency check should handle both relative ("dispatcher") and absolute paths to dispatcher
---

## 2026-01-24 - #9/US-008
- Added `init_wrappers()` function to `scripts/entrypoint.sh`
- Function calls `bridge --init-wrappers /scripts/wrappers` at startup
- Added call to `init_wrappers` in `main()` after `init_firewall`, before dropping to claude user
- Removed `CLAUDE_STARTING` environment variable logic from `run_claude()` function
- Added Test 6 to `.test/run-tests.sh` to verify symlinks exist after container starts

- Files changed:
  - `scripts/entrypoint.sh` - Added init_wrappers function and call, removed CLAUDE_STARTING
  - `.test/run-tests.sh` - Added Test 6 for entrypoint symlink verification

- **Learnings for future iterations:**
  - The init_wrappers function was partially implemented but not called - always verify function is invoked
  - CLAUDE_STARTING env var was a workaround for the old wrapper system - no longer needed with dispatcher + symlinks
  - Entrypoint order matters: firewall first (needs root), then wrappers (needs bridge), then drop to user
---
