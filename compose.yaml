# Docker Compose v2 configuration for ai-dev-container
# =====================================================
# This compose file sets up:
#   1. claude: The main Claude Code container (built from local Dockerfile)
#   2. golang: A Go sidecar container for running go commands via bridge
#   3. socket-proxy: Docker socket proxy for secure, limited Docker access
#   4. viewer: Claude Code Viewer web UI for monitoring sessions
#
# Usage:
#   docker compose up -d      # Start all services
#   docker compose exec claude claude  # Enter Claude interactively (if not using YOLO)
#
# For development on this project, this allows Claude to run go commands
# (go build, go test, go vet, etc.) in the golang sidecar container.

services:
  # Docker socket proxy - limits Docker API access to exec operations only
  socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: ai-dev-container-socket-proxy
    environment:
      # Only allow container inspection and exec operations
      - CONTAINERS=1
      - EXEC=1
      - POST=1
      # Disable all other Docker API endpoints
      - IMAGES=0
      - NETWORKS=0
      - VOLUMES=0
      - SERVICES=0
      - TASKS=0
      - NODES=0
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - PLUGINS=0
      - SECRETS=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
    volumes:
      # Mount Docker socket read-only to socket-proxy only
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

  # Main Claude Code container
  claude:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-dev-container-claude
    stdin_open: true
    tty: true
    environment:
      # Set CLAUDE_YOLO=1 to enable --dangerously-skip-permissions mode
      - CLAUDE_YOLO=${CLAUDE_YOLO:-0}
      # Enable bridge wrappers to route commands to sidecar containers
      - BRIDGE_ENABLED=1
      # Point bridge to the config file
      - BRIDGE_CONFIG=/workspace/.claude/bridge.yaml
      # Docker host via socket proxy for secure, limited Docker access
      - DOCKER_HOST=tcp://socket-proxy:2375
    volumes:
      # Mount current project directory as workspace
      - .:/workspace
      # Named volume for Claude session persistence and config (per-project)
      - claude-config:/home/claude/.claude
      - claude-home:/home/claude/
      # Mount credentials file extracted from host (macOS keychain or Linux ~/.claude/.credentials.json)
      # See README for extraction instructions
      - ./.credentials.json:/home/claude/.claude/.credentials.json:ro
      - /dev/null:/workspace/.env
      - /dev/null:/workspace/.credentials.json
    depends_on:
      - socket-proxy
      - golang
    working_dir: /workspace

  # Go sidecar container for running go commands
  golang:
    image: golang:1.24-alpine
    container_name: ai-dev-container-golang
    command: ["sleep", "infinity"]
    volumes:
      # Mount current project directory (same as claude container)
      - .:/workspace
    working_dir: /workspace

  # Claude Code Viewer - web UI for monitoring Claude sessions
  viewer:
    image: node:20-alpine
    container_name: ai-dev-container-viewer
    command: ["npx", "@kimuson/claude-code-viewer@latest", "--hostname", "0.0.0.0"]
    environment:
      - PORT=${VIEWER_PORT:-3000}
      # Point viewer to the mounted claude data directory (read-only)
      - CCV_GLOBAL_CLAUDE_DIR=/claude-data
    ports:
      - "${VIEWER_PORT:-3000}:${VIEWER_PORT:-3000}"
    volumes:
      # Mount claude-config volume read-only at custom path to avoid permission conflicts
      - claude-config:/claude-data:ro
    restart: unless-stopped

# Named volumes for persistent storage
volumes:
  # Per-project Claude config volume (stores credentials, settings, etc.)
  claude-config:
  claude-home:
