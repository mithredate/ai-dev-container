#!/bin/sh
# shellcheck shell=dash
# Claude wrapper - handles user switching and YOLO mode
#
# When running as root (e.g., via docker compose exec), this wrapper:
# 1. Re-executes as the 'claude' user (required for --dangerously-skip-permissions)
# 2. Checks CLAUDE_YOLO=1 to add --dangerously-skip-permissions flag
#
# Usage:
#   docker compose exec claude claude                    # Normal mode
#   docker compose exec -e CLAUDE_YOLO=1 claude claude   # YOLO mode

REAL_CLAUDE="/usr/local/bin/claude"
CONTAINER_USER="claude"

# If running as root, re-exec as claude user
if [ "$(id -u)" -eq 0 ]; then
    # Build argument string for su -c (handles most common cases)
    # Note: Arguments with spaces may not be preserved perfectly
    ARGS=""
    for arg in "$@"; do
        ARGS="$ARGS \"$arg\""
    done
    exec su -s /bin/sh "$CONTAINER_USER" -c "CLAUDE_YOLO=\"$CLAUDE_YOLO\" \"$0\" $ARGS"
fi

# Now running as claude user
# Set CLAUDE_STARTING=1 so the node wrapper uses native node for Claude's startup
# (Claude Code is a Node.js app). The node wrapper will unset this for child processes.
export CLAUDE_STARTING=1

# Check for YOLO mode
if [ "$CLAUDE_YOLO" = "1" ]; then
    exec "$REAL_CLAUDE" --dangerously-skip-permissions "$@"
else
    exec "$REAL_CLAUDE" "$@"
fi
