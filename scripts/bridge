#!/bin/sh
# shellcheck shell=dash
# Claude Bridge Script
# ====================
# Routes commands from the Claude container to sidecar containers via Docker socket.
# Config file: /workspace/.claude/bridge.yaml

set -e

# Configuration
CONFIG_FILE="${BRIDGE_CONFIG:-/workspace/.claude/bridge.yaml}"

# Colors for output (disabled if not a terminal)
if [ -t 1 ]; then
    RED='\033[0;31m'
    YELLOW='\033[0;33m'
    NC='\033[0m' # No Color
else
    RED=''
    YELLOW=''
    NC=''
fi

# Print error message and exit
error() {
    printf "${RED}error:${NC} %s\n" "$1" >&2
    exit 1
}

# Print warning message
warn() {
    printf "${YELLOW}warning:${NC} %s\n" "$1" >&2
}

# Show usage information
usage() {
    cat <<EOF
Usage: bridge <command> [arguments...]

Routes commands to the appropriate sidecar container as defined in the
bridge configuration file.

Configuration file: ${CONFIG_FILE}

Options:
  --help, -h     Show this help message
  --version      Show version information
  --config       Show parsed configuration

Examples:
  bridge php -v                  Run 'php -v' in PHP container
  bridge artisan migrate         Run Laravel migrations
  bridge test:php --filter=User  Run PHPUnit tests with filter
  bridge npm install             Install npm packages

For configuration format, see: examples/claude-bridge.yaml
EOF
    exit 0
}

# Show version
version() {
    echo "bridge 1.0.0"
    exit 0
}

# Check if yq is available
check_yq() {
    if ! command -v yq >/dev/null 2>&1; then
        error "yq is required but not installed. Please install yq (https://github.com/mikefarah/yq)"
    fi
}

# Check if config file exists
check_config_exists() {
    if [ ! -f "$CONFIG_FILE" ]; then
        error "config file not found: ${CONFIG_FILE}

Create a bridge.yaml configuration file at the above path.
See examples/claude-bridge.yaml for the expected format."
    fi
}

# Validate config file format
validate_config() {
    # Check if file is valid YAML
    if ! yq '.' "$CONFIG_FILE" >/dev/null 2>&1; then
        error "invalid YAML syntax in config file: ${CONFIG_FILE}

Please check the file for syntax errors. Common issues:
  - Missing colons after keys
  - Incorrect indentation
  - Unquoted special characters"
    fi

    # Check for required 'version' field
    local version
    version=$(yq '.version // ""' "$CONFIG_FILE")
    if [ -z "$version" ]; then
        error "config file missing required 'version' field

Add 'version: \"1\"' at the top of your config file."
    fi

    # Check version is supported
    if [ "$version" != "1" ]; then
        error "unsupported config version: ${version}

Currently supported versions: 1"
    fi

    # Check for required 'commands' section
    local commands_type
    commands_type=$(yq '.commands | type' "$CONFIG_FILE")
    if [ "$commands_type" = "null" ] || [ "$commands_type" = "!!" ]; then
        error "config file missing required 'commands' section

The 'commands' section maps command aliases to containers.
See examples/claude-bridge.yaml for the expected format."
    fi
}

# Parse and display configuration
show_config() {
    check_yq
    check_config_exists
    validate_config

    echo "Configuration file: ${CONFIG_FILE}"
    echo ""
    echo "Parsed configuration:"
    yq '.' "$CONFIG_FILE"
    exit 0
}

# Get a value from the config file
config_get() {
    yq "$1" "$CONFIG_FILE"
}

# Load and parse the configuration
load_config() {
    check_yq
    check_config_exists
    validate_config
}

# Resolve container name using containers section overrides
# $1: logical container name
# Returns: actual container name (or original if no override exists)
resolve_container_name() {
    local logical_name="$1"
    local actual_name

    # Look up in containers section
    actual_name=$(yq ".containers.${logical_name} // \"\"" "$CONFIG_FILE")

    # If no override, use the logical name as-is
    if [ -z "$actual_name" ] || [ "$actual_name" = "null" ]; then
        echo "$logical_name"
    else
        echo "$actual_name"
    fi
}

# Look up command configuration
# $1: command name
# Sets global variables: CMD_CONTAINER, CMD_EXEC, CMD_WORKDIR
lookup_command() {
    local cmd="$1"
    local cmd_config

    # Check if command exists in config
    cmd_config=$(yq ".commands[\"${cmd}\"] // \"\"" "$CONFIG_FILE")

    if [ -z "$cmd_config" ] || [ "$cmd_config" = "null" ]; then
        # Command not found, check for default_container
        local default_container
        default_container=$(yq '.default_container // ""' "$CONFIG_FILE")

        if [ -z "$default_container" ] || [ "$default_container" = "null" ]; then
            error "unknown command: ${cmd}

This command is not defined in the bridge configuration.
Add it to the 'commands' section in: ${CONFIG_FILE}

Or set 'default_container' to handle unrecognized commands."
        fi

        # Use default container with the command itself as exec
        CMD_CONTAINER=$(resolve_container_name "$default_container")
        CMD_EXEC="$cmd"
        CMD_WORKDIR=""
        return 0
    fi

    # Command found, extract configuration
    local container_logical
    container_logical=$(yq ".commands[\"${cmd}\"].container // \"\"" "$CONFIG_FILE")

    if [ -z "$container_logical" ] || [ "$container_logical" = "null" ]; then
        error "command '${cmd}' is missing required 'container' field in config"
    fi

    CMD_CONTAINER=$(resolve_container_name "$container_logical")
    CMD_EXEC=$(yq ".commands[\"${cmd}\"].exec // \"\"" "$CONFIG_FILE")
    CMD_WORKDIR=$(yq ".commands[\"${cmd}\"].workdir // \"\"" "$CONFIG_FILE")

    # Exec defaults to the command name if not specified
    if [ -z "$CMD_EXEC" ] || [ "$CMD_EXEC" = "null" ]; then
        CMD_EXEC="$cmd"
    fi

    # Clean up null workdir
    if [ "$CMD_WORKDIR" = "null" ]; then
        CMD_WORKDIR=""
    fi
}

# Build and execute docker command
# $1: command name
# $@: additional arguments to pass to the command
route_command() {
    local cmd="$1"
    shift  # Remove command name, leaving only additional args

    # Look up command configuration
    lookup_command "$cmd"

    # Build docker exec command
    local docker_cmd="docker exec"

    # Add workdir if specified
    if [ -n "$CMD_WORKDIR" ]; then
        docker_cmd="$docker_cmd -w $CMD_WORKDIR"
    fi

    # Add container name
    docker_cmd="$docker_cmd $CMD_CONTAINER"

    # Add the exec command
    # Note: CMD_EXEC may contain spaces (e.g., "php artisan")
    # We need to handle this properly
    docker_cmd="$docker_cmd $CMD_EXEC"

    # Execute the command with any additional arguments
    # Using eval to properly handle CMD_EXEC with spaces
    # shellcheck disable=SC2086
    $docker_cmd "$@"
}

# Main entry point
main() {
    # Handle options
    case "${1:-}" in
        --help|-h)
            usage
            ;;
        --version)
            version
            ;;
        --config)
            show_config
            ;;
        "")
            error "no command specified. Use 'bridge --help' for usage."
            ;;
    esac

    # Load configuration for command routing
    load_config

    # Route the command to the appropriate container
    route_command "$@"
}

main "$@"
